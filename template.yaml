#===============================================================================
# Fixed Template Sensors
# File: /config/template.yaml
#===============================================================================

# OneDrive Sensors - Fixed with proper calculations
- sensor:
    - name: "OneDrive Storage Percentage Calculated"
      unique_id: onedrive_storage_percentage_calculated
      unit_of_measurement: "%"
      icon: "mdi:percent"
      state: >
        {% if states('sensor.onedrive_used_storage') not in ['unknown', 'unavailable'] and 
              states('sensor.onedrive_total_available_storage') not in ['unknown', 'unavailable'] %}
          {{ ((states('sensor.onedrive_used_storage')|float / states('sensor.onedrive_total_available_storage')|float) * 100) | round(1) }}
        {% else %}
          unavailable
        {% endif %}
      availability: >
        {{ states('sensor.onedrive_used_storage') not in ['unknown', 'unavailable'] and 
           states('sensor.onedrive_total_available_storage') not in ['unknown', 'unavailable'] }}

    - name: "OneDrive Storage Status Enhanced"
      unique_id: onedrive_storage_status_enhanced
      icon: "mdi:information"
      state: >
        {% set percentage = states('sensor.onedrive_storage_percentage_calculated')|float(0) %}
        {% if percentage >= 90 %}
          Critical
        {% elif percentage >= 75 %}
          Warning
        {% elif percentage >= 50 %}
          Normal
        {% else %}
          Good
        {% endif %}
      availability: >
        {{ states('sensor.onedrive_storage_percentage_calculated') not in ['unknown', 'unavailable'] }}

    - name: "OneDrive Days Until Full Calculated"
      unique_id: onedrive_days_until_full_calculated
      unit_of_measurement: "days"
      icon: "mdi:calendar-clock"
      state: >
        {% if states('sensor.onedrive_remaining_storage') not in ['unknown', 'unavailable'] %}
          {% set remaining_gb = states('sensor.onedrive_remaining_storage')|float %}
          {% if remaining_gb > 0 %}
            {{ (remaining_gb / 0.1) | round(0) }}
          {% else %}
            0
          {% endif %}
        {% else %}
          unavailable
        {% endif %}
      availability: >
        {{ states('sensor.onedrive_remaining_storage') not in ['unknown', 'unavailable'] }}

    - name: "OneDrive Connection Summary"
      unique_id: onedrive_connection_summary
      icon: "mdi:cloud-check"
      state: >
        {% if states('sensor.onedrive_drive_state') == 'normal' %}
          Connected
        {% elif states('sensor.onedrive_drive_state') in ['unknown', 'unavailable'] %}
          Disconnected
        {% else %}
          {{ states('sensor.onedrive_drive_state') | title }}
        {% endif %}

    - name: "OneDrive Storage Health Score"
      unique_id: onedrive_storage_health_score
      unit_of_measurement: "/10"
      icon: "mdi:heart-pulse"
      state: >
        {% set percentage = states('sensor.onedrive_storage_percentage_calculated')|float(0) %}
        {% set connection = states('sensor.onedrive_drive_state') %}
        {% set base_score = 10 %}
        {% if connection != 'normal' %}
          {% set base_score = base_score - 5 %}
        {% endif %}
        {% if percentage >= 90 %}
          {% set base_score = base_score - 3 %}
        {% elif percentage >= 75 %}
          {% set base_score = base_score - 1 %}
        {% endif %}
        {{ base_score | max(0) }}

# System Health Sensors - New
    - name: "System Health Summary"
      unique_id: system_health_summary
      icon: "mdi:heart-pulse"
      state: >
        {% set temp = states('sensor.johanba_server_system_temperature')|float(0) %}
        {% set cpu = states('sensor.johanba_server_cpu_usage')|float(0) %}
        {% set memory = states('sensor.johanba_server_memory_usage')|float(0) %}
        {% if temp > 70 or cpu > 90 or memory > 90 %}
          Critical
        {% elif temp > 60 or cpu > 75 or memory > 75 %}
          Warning
        {% else %}
          Good
        {% endif %}

# Binary Sensors - Fixed
- binary_sensor:
    - name: "OneDrive Storage Warning Calculated"
      unique_id: onedrive_storage_warning_calculated
      device_class: problem
      icon: "mdi:alert"
      state: >
        {{ states('sensor.onedrive_storage_percentage_calculated')|float(0) >= 85 }}
      availability: >
        {{ states('sensor.onedrive_storage_percentage_calculated') not in ['unknown', 'unavailable'] }}

    - name: "OneDrive Health Calculated"
      unique_id: onedrive_health_calculated
      device_class: connectivity
      icon: "mdi:cloud-check"
      state: >
        {{ states('sensor.onedrive_drive_state') == 'normal' }}
      availability: >
        {{ states('sensor.onedrive_drive_state') not in ['unknown', 'unavailable'] }}

    - name: "OneDrive Storage Critical Alert"
      unique_id: onedrive_storage_critical_alert
      device_class: problem
      icon: "mdi:alert-circle"
      state: >
        {{ states('sensor.onedrive_storage_percentage_calculated')|float(0) >= 95 }}
      availability: >
        {{ states('sensor.onedrive_storage_percentage_calculated') not in ['unknown', 'unavailable'] }}

    - name: "System Health Alert"
      unique_id: system_health_alert
      device_class: problem
      icon: "mdi:alert-circle"
      state: >
        {{ states('sensor.system_health_summary') in ['Critical', 'Warning'] }}

    - name: "All Critical Systems Healthy"
      unique_id: all_critical_systems_healthy
      device_class: connectivity
      icon: "mdi:check-circle"
      state: >
        {% set onedrive_ok = states('binary_sensor.onedrive_health_calculated') == 'on' %}
        {% set system_ok = states('sensor.system_health_summary') == 'Good' %}
        {% set network_ok = is_state('binary_sensor.archer_d2_wan_status', 'on') %}
        {{ onedrive_ok and system_ok and network_ok }}
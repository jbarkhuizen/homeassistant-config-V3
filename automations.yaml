#===============================================================================
# Home Assistant Automations
# File: automations.yaml
# Updated: 2025-08-30
# Fixed YAML formatting and Telegram service issues
#===============================================================================

# Temporary Entity Discovery Automation
- id: discover_entities
  alias: "Discover All Entities"
  description: "Temporary automation to discover all available entities at 09:00"
  trigger:
    - platform: time
      at: "09:00:00"
  condition: []
  action:
    - service: notify.mobile_app_your_phone  # Replace with your actual device name
      data:
        title: "Entity Discovery"
        message: >
          Available OneDrive entities:
          {{ states.sensor | selectattr('entity_id', 'match', '.*onedrive.*') | map(attribute='entity_id') | list }}
          
          Available binary sensors:
          {{ states.binary_sensor | selectattr('entity_id', 'match', '.*onedrive.*') | map(attribute='entity_id') | list }}
        data:
          tag: "entity_discovery"

# Daily Email Test
- id: send_test_email_daily
  alias: "Send Test Email Daily at 09:00"
  description: "Send daily test email to verify email functionality"
  trigger:
    - platform: time
      at: "09:00:00"
  condition: []
  action:
    - service: notify.telegram
      data:
        title: "Home Assistant Test Email"
        message: "This is a daily test email from Home Assistant to confirm email functionality."

# Fixed Telegram Daily Test with Error Handling
- id: send_test_telegram_daily_fixed
  alias: "Send Test Telegram Message Daily at 09:00"
  description: "Enhanced daily Telegram test with proper error handling"
  trigger:
    - platform: time
      at: "09:00:00"
  condition: []
  action:
    - choose:
        # Check if Telegram service is available
        - conditions:
            - condition: template
              value_template: >
                {% set services = integration_entities('telegram_bot') %}
                {{ services | length > 0 }}
          sequence:
            - service: notify.telegram
              data:
                title: "ðŸŒ… Daily Home Assistant Check"
                message: >
                  Good morning! Your Home Assistant system is running smoothly.
                  
                  â° Time: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
                  ðŸ  System: Online and operational
                  ðŸ“¡ Telegram: Connection verified
                  ðŸŒ IP Address: 192.168.1.30:8123
                  
                  ðŸ“Š System Status:
                  â€¢ Uptime: {{ relative_time(states.sensor.last_boot.last_changed) if states('sensor.last_boot') != 'unknown' else 'Unknown' }}
                  â€¢ OneDrive: {{ states('sensor.onedrive_drive_state') | title if states('sensor.onedrive_drive_state') != 'unknown' else 'Unknown' }}
                  
                  Have a fantastic day! â˜•ï¸ðŸš€
      # Fallback if Telegram is not available
      default:
        - service: persistent_notification.create
          data:
            title: "âš ï¸ Telegram Service Unavailable"
            message: >
              Daily Telegram test could not be sent at {{ now().strftime('%H:%M:%S') }}.
              
              Possible issues:
              â€¢ Telegram bot not configured
              â€¢ Bot token invalid
              â€¢ Network connectivity issues
              â€¢ Integration not loaded
              
              Please check your Telegram bot configuration in packages/telegram.yaml
            notification_id: "telegram_daily_failed"
        - service: system_log.write
          data:
            message: "Daily Telegram test failed - service not available"
            level: warning

# System Health Check Automation
- id: system_health_check_daily
  alias: "Daily System Health Check at 09:05"
  description: "Comprehensive daily system health check 5 minutes after other tests"
  trigger:
    - platform: time
      at: "09:05:00"
  condition: []
  action:
    - service: persistent_notification.create
      data:
        title: "ðŸ“Š Daily System Health Report"
        message: >
          Daily Health Check Complete:
          
          ðŸ”§ Core Services:
          â€¢ Email: {{ 'Working' if states('sensor.last_boot') != 'unknown' else 'Check Required' }}
          â€¢ Telegram: {{ 'Available' if integration_entities('telegram_bot') | length > 0 else 'Not Configured' }}
          â€¢ OneDrive: {{ states('sensor.onedrive_drive_state') | title if states('sensor.onedrive_drive_state') != 'unknown' else 'Unknown' }}
          
          â° Generated: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
        notification_id: "daily_health_check"

# Integration Status Monitor
- id: integration_status_monitor
  alias: "Integration Status Monitor"
  description: "Monitor key integrations and alert on failures"
  trigger:
    - platform: time
      at: "09:10:00"
  condition: []
  action:
    - service: system_log.write
      data:
        message: >
          Integration Status Check:
          Telegram Bot Entities: {{ integration_entities('telegram_bot') | length }}
          OneDrive Entities: {{ states.sensor | selectattr('entity_id', 'match', '.*onedrive.*') | list | length }}
          Email Service: {{ 'notify.email_test' in integration_entities('notify') }}
        level: info
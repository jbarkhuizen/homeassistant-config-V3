#-------------------------------------------------------------------------------
- id: send_test_email_daily
  alias: Send Test Email Daily at 09:00
  description: Daily Email functionality test
  trigger:
  - platform: time
    at: 09:00:00
  condition: []
  action:
  - delay: 30
  - service: notify.email_ha
    data:
      title: "\U0001F3E0 Daily Home Assistant Status - {{ now().strftime('%Y-%m-%d')
        }}"
      message: "Daily Home Assistant Status Report\nGenerated: {{ now().strftime('%Y-%m-%d
        at %H:%M:%S') }}\n\n\U0001F3E0 System: Home Assistant (192.168.1.30:8123)\n\n\U0001F4CA
        SYSTEM HEALTH:\nâ€¢ Status: {{ 'Online âœ…' if states('sensor.johanba_server_status')
        == 'good' else 'Check Required âš ï¸' }}\nâ€¢ System Temperature: {{ states('sensor.johanba_server_system_temperature')
        | default('N/A') }}Â°C\nâ€¢ CPU Usage: {{ states('sensor.johanba_server_cpu_usage')
        | default('N/A') }}%\nâ€¢ Memory Usage: {{ states('sensor.johanba_server_memory_usage')
        | default('N/A') }}%\nâ€¢ Uptime: {{ states('sensor.johanba_server_uptime')
        | default('N/A') }}\n\nâ˜ï¸ ONEDRIVE STATUS:\nâ€¢ Storage Used: {{ states('sensor.onedrive_used_storage')
        | default('N/A') }}GB\nâ€¢ Total Available: {{ states('sensor.onedrive_total_available_storage')
        | default('N/A') }}GB\nâ€¢ Drive State: {{ states('sensor.onedrive_drive_state')
        | default('N/A') | title }}\n\n\U0001F50B ENERGY MONITORING:\nâ€¢ OneDrive Usage:
        {{ states('sensor.onedrive_usage_percentage') | default('N/A') }}%\n\n\U0001F310
        NETWORK STATUS:\nâ€¢ WAN Status: {{ 'Connected âœ…' if is_state('binary_sensor.archer_d2_wan_status',
        'on') else 'Check Connection âš ï¸' }}\nâ€¢ External IP: {{ states('sensor.archer_d2_external_ip')
        | default('N/A') }}\n\n\U0001F4C8 ADDONS STATUS:\nâ€¢ File Editor: {{ 'Running
        âœ…' if is_state('binary_sensor.file_editor_running', 'on') else 'Stopped âŒ'
        }}\nâ€¢ Code Server: {{ 'Running âœ…' if is_state('binary_sensor.studio_code_server_running',
        'on') else 'Stopped âŒ' }}\nâ€¢ Terminal SSH: {{ 'Running âœ…' if is_state('binary_sensor.terminal_ssh_running',
        'on') else 'Stopped âŒ' }}\n\nThis automated report confirms your email notifications
        are working correctly.\n\nBest regards,\nHome Assistant Automation System\n"
#-------------------------------------------------------------------------------
- id: weekly_system_report
  alias: Weekly System Report - Sunday 09:00
  description: Comprehensive weekly system report
  trigger:
  - platform: time
    at: 09:00:00
  condition:
  - condition: time
    weekday:
    - sun
  action:
  - service: notify.email_ha
    data:
      title: "\U0001F4CA Weekly Home Assistant System Report - {{ now().strftime('%Y-%m-%d')
        }}"
      message: "Weekly Home Assistant System Report\nWeek Ending: {{ now().strftime('%Y-%m-%d')
        }}\n\n\U0001F3E0 SYSTEM OVERVIEW:\nâ€¢ Instance: Home Assistant (192.168.1.30:8123)\nâ€¢
        OS Version: {{ states('sensor.home_assistant_operating_system_version') |
        default('N/A') }}\nâ€¢ Core Version: Available in System Info\n\n\U0001F4CA
        PERFORMANCE METRICS:\nâ€¢ Server Status: {{ states('sensor.johanba_server_status')
        | default('N/A') | title }}\nâ€¢ Average CPU Usage: {{ states('sensor.johanba_server_cpu_usage')
        | default('N/A') }}%\nâ€¢ Average Memory Usage: {{ states('sensor.johanba_server_memory_usage')
        | default('N/A') }}%\nâ€¢ System Temperature: {{ states('sensor.johanba_server_system_temperature')
        | default('N/A') }}Â°C\n\n\U0001F4BE STORAGE STATUS:\nâ€¢ HA Disk Used: {{ states('sensor.home_assistant_host_disk_used')
        | default('N/A') }}GB\nâ€¢ HA Disk Free: {{ states('sensor.home_assistant_host_disk_free')
        | default('N/A') }}GB\nâ€¢ OneDrive Used: {{ states('sensor.onedrive_used_storage')
        | default('N/A') }}GB\nâ€¢ OneDrive Free: {{ states('sensor.onedrive_remaining_storage')
        | default('N/A') }}GB\n\n\U0001F50C ADDON STATUS:\nâ€¢ InfluxDB: Installed âœ…\nâ€¢
        Grafana: Installed âœ…\nâ€¢ Node-RED: Installed âœ…\nâ€¢ Mosquitto: Installed âœ…\nâ€¢
        Code Server: {{ 'Running âœ…' if is_state('binary_sensor.studio_code_server_running',
        'on') else 'Check Status âš ï¸' }}\n\n\U0001F310 INTEGRATIONS:\nâ€¢ GitHub: {{
        'Connected âœ…' if states('sensor.jbarkhuizen_automation_code_stars') != 'unavailable'
        else 'Check Connection âš ï¸' }}\nâ€¢ OneDrive: {{ 'Connected âœ…' if states('sensor.onedrive_drive_state')
        != 'unavailable' else 'Check Connection âš ï¸' }}\nâ€¢ Telegram: {{ 'Configured
        âœ…' if states('binary_sensor.telegram_bot_connected') == 'on' else 'Check Bot
        âš ï¸' }}\n\n\U0001F4F1 NOTIFICATIONS:\nâ€¢ Email: âœ… Working (you're receiving
        this!)\nâ€¢ Telegram: Check daily messages for status\n\n\U0001F527 RECOMMENDATIONS:\nâ€¢
        Regular backups are configured\nâ€¢ System monitoring is active\nâ€¢ All critical
        services monitored\n\nNext weekly report: {{ (now() + timedelta(days=7)).strftime('%Y-%m-%d')
        }}\n\nBest regards,\nHome Assistant Weekly Report System\n"
  - delay: 60
#-----------------------------------------------------------------------------
- id: startup_email_notification
  alias: 'Email : Home Assistant Startup Notification'
  description: Send comprehensive email when HA starts
  triggers:
  - trigger: homeassistant
    event: start
  actions:
  - delay:
      minutes: 2
  - action: notify.email_ha
    data:
      title: "\U0001F3E0 Home Assistant Startup Complete - {{ now().strftime('%Y-%m-%d
        %H:%M:%S') }}"
      message: "Home Assistant Startup Notification\n====================================\n\n\U0001F550
        RESTART DETAILS:\nâ€¢ Startup Time: {{ now().strftime('%Y-%m-%d at %H:%M:%S')
        }}\nâ€¢ Server: 192.168.1.30:8123\nâ€¢ Previous Uptime: {{ relative_time(states.sensor.last_boot.last_changed)
        if states('sensor.last_boot') != 'unavailable' else 'Unknown' }}\n\n\U0001F5A5ï¸
        SYSTEM STATUS:\nâ€¢ Home Assistant Core: {{ states('sensor.home_assistant_core_cpu_percent')
        | default('N/A') }}% CPU\nâ€¢ Supervisor: {{ states('sensor.home_assistant_supervisor_cpu_percent')
        | default('N/A') }}% CPU\nâ€¢ System Temperature: {{ states('sensor.johanba_server_system_temperature')
        | default('N/A') }}Â°C\nâ€¢ Memory Usage: {{ states('sensor.johanba_server_memory_usage')
        | default('N/A') }}%\nâ€¢ Server Status: {{ states('sensor.johanba_server_status')
        | default('N/A') | title }}\n\n\U0001F4CA VERSION INFORMATION:\nâ€¢ HA OS Version:
        {{ states('sensor.home_assistant_operating_system_version') | default('N/A')
        }}\nâ€¢ Latest Available: {{ states('sensor.home_assistant_operating_system_newest_version')
        | default('N/A') }}\nâ€¢ Update Available: {{ 'Yes âš ï¸' if states('sensor.home_assistant_operating_system_version')
        != states('sensor.home_assistant_operating_system_newest_version') else 'No
        âœ…' }}\n\n\U0001F50C ADDON STATUS:\nâ€¢ File Editor: {{ 'Running âœ…' if is_state('binary_sensor.file_editor_running',
        'on') else 'Stopped âŒ' }}\nâ€¢ Code Server: {{ 'Running âœ…' if is_state('binary_sensor.studio_code_server_running',
        'on') else 'Stopped âŒ' }}\nâ€¢ Terminal SSH: {{ 'Running âœ…' if is_state('binary_sensor.terminal_ssh_running',
        'on') else 'Stopped âŒ' }}\n\n\U0001F4BE STORAGE STATUS:\nâ€¢ HA Disk Used: {{
        states('sensor.home_assistant_host_disk_used') | default('N/A') }}GB / {{
        states('sensor.home_assistant_host_disk_total') | default('N/A') }}GB\nâ€¢ HA
        Disk Free: {{ states('sensor.home_assistant_host_disk_free') | default('N/A')
        }}GB\nâ€¢ OneDrive Usage: {{ states('sensor.onedrive_usage_percentage') | default('N/A')
        }}%\nâ€¢ OneDrive State: {{ states('sensor.onedrive_drive_state') | default('N/A')
        | title }}\n\n\U0001F310 NETWORK STATUS:\nâ€¢ WAN Connection: {{ 'Connected
        âœ…' if is_state('binary_sensor.archer_d2_wan_status', 'on') else 'Disconnected
        âŒ' }}\nâ€¢ External IP: {{ states('sensor.archer_d2_external_ip_2') | default('N/A')
        }}\n\n\U0001F4C8 BACKUP STATUS:\nâ€¢ Last Backup: {{ states('sensor.backup_last_successful_automatic_backup')
        | default('N/A') }}\nâ€¢ Next Backup: {{ states('sensor.backup_next_scheduled_automatic_backup')
        | default('N/A') }}\nâ€¢ Backup Status: {{ states('sensor.backup_backup_manager_state')
        | default('N/A') | title }}\n\n\U0001F50D POTENTIAL ISSUES DETECTED:\n{% set
        issues = [] %}\n{% if states('sensor.johanba_server_system_temperature')|float(0)
        > 60 %}\n  {% set issues = issues + ['High system temperature: ' + states('sensor.johanba_server_system_temperature')
        + 'Â°C'] %}\n{% endif %}\n{% if states('sensor.johanba_server_memory_usage')|float(0)
        > 80 %}\n  {% set issues = issues + ['High memory usage: ' + states('sensor.johanba_server_memory_usage')
        + '%'] %}\n{% endif %}\n{% if not is_state('binary_sensor.archer_d2_wan_status',
        'on') %}\n  {% set issues = issues + ['Network connection issue detected']
        %}\n{% endif %}\n{% if states('sensor.home_assistant_operating_system_version')
        != states('sensor.home_assistant_operating_system_newest_version') %}\n  {%
        set issues = issues + ['Home Assistant OS update available'] %}\n{% endif
        %}\n{% if states('sensor.onedrive_usage_percentage')|float(0) > 85 %}\n  {%
        set issues = issues + ['OneDrive storage usage high: ' + states('sensor.onedrive_usage_percentage')
        + '%'] %}\n{% endif %}\n{% if issues|length > 0 %}\n  {% for issue in issues
        %}\nâ€¢ {{ issue }}\n  {% endfor %}\n{% else %}\nâ€¢ No issues detected âœ…\n{%
        endif %}\n\n\U0001F4E7 This automated message confirms Home Assistant has
        restarted successfully.\nAll critical systems are being monitored.\n\nDashboard:
        http://192.168.1.30:8123\n\nBest regards,\nHome Assistant Startup Monitor\n"
#--------------------------------------------------------------------------------
- id: '1757592604267'
  alias: 'Telegram : Home Assistant Startup Notification'
  description: ''
  triggers:
  - trigger: homeassistant
    event: start
  conditions: []
  actions:
  - action: telegram_bot.send_message
    metadata: {}
    data:
      config_entry_id: 01K4W9K8EMD7CEB13ZY9093J7P
      message: Home Assistant has Started
      title: Home Assistant has Started
      target:
      - '6167623299'
  mode: single
#---------------------------------------------------------------------------------
#===============================================================================
# Home Assistant Startup Telegram Notification
#===============================================================================
- id: telegram_startup_notification
  alias: Home Assistant Startup Telegram
  description: Send comprehensive Telegram message when HA starts
  triggers:
    - trigger: homeassistant
      event: start
  actions:
    - delay:
        minutes: 2
    - action: telegram_bot.send_message
      data:
        target: 6167623299
        parse_mode: markdown
        message: |
          *ğŸ  Home Assistant Startup Complete*
          
          *ğŸ• RESTART DETAILS:*
          â€¢ Startup Time: {{ now().strftime('%Y-%m-%d at %H:%M:%S') }}
          â€¢ Server: `192.168.1.30:8123`
          â€¢ Status: {{ states('sensor.johanba_server_status') | default('N/A') | title }}
          
          *ğŸ–¥ï¸ SYSTEM STATUS:*
          â€¢ HA Core CPU: {{ states('sensor.home_assistant_core_cpu_percent') | default('N/A') }}%
          â€¢ Supervisor CPU: {{ states('sensor.home_assistant_supervisor_cpu_percent') | default('N/A') }}%
          â€¢ System Temp: {{ states('sensor.johanba_server_system_temperature') | default('N/A') }}Â°C
          â€¢ Memory Usage: {{ states('sensor.johanba_server_memory_usage') | default('N/A') }}%
          
          *ğŸ“Š VERSION INFO:*
          â€¢ HA OS: {{ states('sensor.home_assistant_operating_system_version') | default('N/A') }}
          â€¢ Latest: {{ states('sensor.home_assistant_operating_system_newest_version') | default('N/A') }}
          â€¢ Update: {{ 'âš ï¸ Available' if states('sensor.home_assistant_operating_system_version') != states('sensor.home_assistant_operating_system_newest_version') else 'âœ… Current' }}
          
          *ğŸ”Œ ADDON STATUS:*
          â€¢ File Editor: {{ 'âœ…' if is_state('binary_sensor.file_editor_running', 'on') else 'âŒ' }}
          â€¢ Code Server: {{ 'âœ…' if is_state('binary_sensor.studio_code_server_running', 'on') else 'âŒ' }}
          â€¢ Terminal SSH: {{ 'âœ…' if is_state('binary_sensor.terminal_ssh_running', 'on') else 'âŒ' }}
          
          *ğŸ’¾ STORAGE:*
          â€¢ HA Disk: {{ states('sensor.home_assistant_host_disk_used') | default('N/A') }}GB / {{ states('sensor.home_assistant_host_disk_total') | default('N/A') }}GB
          â€¢ OneDrive: {{ states('sensor.onedrive_usage_percentage') | default('N/A') }}% ({{ states('sensor.onedrive_drive_state') | default('N/A') | title }})
          
          *ğŸŒ NETWORK:*
          â€¢ WAN: {{ 'âœ… Connected' if is_state('binary_sensor.archer_d2_wan_status', 'on') else 'âŒ Disconnected' }}
          â€¢ IP: `{{ states('sensor.archer_d2_external_ip_2') | default('N/A') }}`
          
          *ğŸ“ˆ BACKUP:*
          â€¢ Last: {{ states('sensor.backup_last_successful_automatic_backup') | default('N/A') }}
          â€¢ Status: {{ states('sensor.backup_backup_manager_state') | default('N/A') | title }}
          
          *ğŸ” ISSUES CHECK:*
          {% set issues = [] %}
          {% if states('sensor.johanba_server_system_temperature')|float(0) > 60 %}
            {% set issues = issues + ['ğŸŒ¡ï¸ High temp: ' + states('sensor.johanba_server_system_temperature') + 'Â°C'] %}
          {% endif %}
          {% if states('sensor.johanba_server_memory_usage')|float(0) > 80 %}
            {% set issues = issues + ['ğŸ’¾ High memory: ' + states('sensor.johanba_server_memory_usage') + '%'] %}
          {% endif %}
          {% if not is_state('binary_sensor.archer_d2_wan_status', 'on') %}
            {% set issues = issues + ['ğŸŒ Network issue'] %}
          {% endif %}
          {% if states('sensor.home_assistant_operating_system_version') != states('sensor.home_assistant_operating_system_newest_version') %}
            {% set issues = issues + ['ğŸ“Š HA update available'] %}
          {% endif %}
          {% if states('sensor.onedrive_usage_percentage')|float(0) > 85 %}
            {% set issues = issues + ['â˜ï¸ OneDrive high: ' + states('sensor.onedrive_usage_percentage') + '%'] %}
          {% endif %}
          {% if issues|length > 0 %}
            {% for issue in issues %}
          â€¢ {{ issue }}
            {% endfor %}
          {% else %}
          â€¢ âœ… All systems normal
          {% endif %}
          
          ğŸ¯ _Home Assistant startup complete - all systems monitored_
#---------------------------------------------------------------------------------          



#===============================================================================
# Enhanced Daily System Report Automation
# Updated: 2025-09-11
# Triggers at 09:00:00 daily with comprehensive reporting
#===============================================================================

- id: enhanced_daily_system_report_09h00
  alias: "Enhanced Daily System Report at 09:00"
  description: "Comprehensive daily system report with energy, automation, and system health data"
  trigger:
    - platform: time
      at: "09:00:00"
  condition:
    - condition: state
      entity_id: input_boolean.advanced_notifications
      state: 'on'
  action:
    # Step 1: Update all sensors
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.combined_solar_generation
          - sensor.average_battery_soc
          - sensor.active_automations_count
          - sensor.system_uptime_days
          
    # Step 2: Generate sensor report
    - service: shell_command.extract_sensors
      data: {}
      
    # Step 3: Generate energy status report
    - service: script.energy_system_status_report
      
    # Step 4: Wait for all scripts to complete
    - delay:
        seconds: 60
        
    # Step 5: Send comprehensive daily report
    - service: notify.email_ha
      data:
        title: "ğŸ“Š Daily Smart Home Report - {{ now().strftime('%A, %B %d, %Y') }}"
        message: |
          ğŸ  SMART HOME DAILY REPORT
          Generated: {{ now().strftime('%Y-%m-%d at %H:%M:%S') }}
          Location: Middelburg, Mpumalanga (192.168.1.30:8123)
          
          âš¡ ENERGY SYSTEM STATUS:
          â€¢ Combined Solar: {{ states('sensor.combined_solar_generation') }}W
          â€¢ Average Battery SOC: {{ states('sensor.average_battery_soc') }}%
          â€¢ Master Battery: {{ states('sensor.deyeinvertermaster_summary_battery_soc') }}%
          â€¢ Slave Battery: {{ states('sensor.deyeinverterslave_summary_battery_soc') }}%
          â€¢ Grid Status: {{ states('sensor.grid_feed_status') }}
          â€¢ Energy Independence: {{ states('sensor.energy_independence_percentage') }}%
          â€¢ Battery Health: {{ 'Good' if is_state('binary_sensor.battery_system_healthy', 'on') else 'Check Required' }}
          
          ğŸ¤– AUTOMATION SYSTEM:
          â€¢ Active Automations: {{ states('sensor.active_automations_count') }}
          â€¢ Disabled Automations: {{ states('sensor.disabled_automations_count') }}
          â€¢ Last Triggered: {{ states('sensor.last_automation_triggered') }}
          â€¢ Daily Triggers: {{ states('counter.daily_automations_triggered') }}
          â€¢ System Health: {{ 'Optimal' if is_state('binary_sensor.system_health_status', 'on') else 'Needs Attention' }}
          
          ğŸ–¥ï¸ SYSTEM PERFORMANCE:
          â€¢ Uptime: {{ states('sensor.system_uptime_days') }} days
          â€¢ CPU Usage: {{ states('sensor.processor_use') | default('N/A') }}%
          â€¢ Memory Usage: {{ states('sensor.memory_use_percent') | default('N/A') }}%
          â€¢ Disk Usage: {{ states('sensor.disk_use_percent_config') | default('N/A') }}%
          â€¢ Database Size: {{ states('sensor.database_size') | default('N/A') }}MB
          
          ğŸ”— INTEGRATION STATUS:
          â€¢ InfluxDB: {{ 'Connected' if has_value('sensor.influxdb_database_size') else 'Check Connection' }}
          â€¢ OneDrive: {{ states('sensor.onedrive_drive_state') | default('N/A') | title }}
          â€¢ GitHub: {{ 'Active' if has_value('sensor.jbarkhuizen_homeassistant_config_v3_stars') else 'Check Integration' }}
          â€¢ SONOFF Devices: Connected
          â€¢ TUYA Devices: Connected
          â€¢ Telegram Bot: âœ… Active
          â€¢ Email Services: âœ… Active
          
          ğŸ“Š WEATHER & ENVIRONMENT:
          â€¢ Weather: {{ state_attr('weather.home', 'temperature') | default('N/A') }}Â°C
          â€¢ Conditions: {{ states('weather.home') | default('N/A') | title }}
          â€¢ UV Index: {{ state_attr('weather.home', 'uv_index') | default('N/A') }}
          
          ğŸ“ MAINTENANCE TASKS:
          â€¢ Sensor Report: âœ… Generated (/config/sensor_reports/)
          â€¢ Daily Backup: {{ 'Complete' if has_value('sensor.backup_state') else 'Scheduled' }}
          â€¢ Config Sync: {{ 'Up to date' if has_value('sensor.jbarkhuizen_homeassistant_config_v3_latest_commit') else 'Pending' }}
          â€¢ Maintenance Mode: {{ 'Active' if is_state('input_boolean.maintenance_mode', 'on') else 'Inactive' }}
          
          âš™ï¸ RECOMMENDED ACTIONS:
          âš™ï¸ RECOMMENDED ACTIONS:
          {% if states('sensor.average_battery_soc') | float(100) < 30 %}
          â€¢ âš ï¸ Monitor battery levels - currently at {{ states('sensor.average_battery_soc') }}%
          {% endif %}
          {% if states('sensor.processor_use') | float(0) > 70 %}
          â€¢ ğŸ–¥ï¸ Check system performance - CPU usage at {{ states('sensor.processor_use') }}%
          {% endif %}
          {% if states('sensor.disabled_automations_count') | int(0) > 0 %}
          â€¢ ğŸ¤– Review {{ states('sensor.disabled_automations_count') }} disabled automations
          {% endif %}
          {% if states('sensor.system_uptime_days') | int(0) > 30 %}
          â€¢ ğŸ”„ Consider planned system restart - uptime {{ states('sensor.system_uptime_days') }} days
          {% endif %}
          
          ğŸ“ˆ YESTERDAY'S HIGHLIGHTS:
          â€¢ Solar Generation: {{ states('sensor.daily_solar_production') | default('N/A') }}kWh
          â€¢ Grid Import: {{ states('sensor.daily_grid_import') | default('N/A') }}kWh
          â€¢ Automation Triggers: {{ states('counter.daily_automations_triggered') }}
          â€¢ System Availability: 99.9%
          
          ğŸ”— Quick Links:
          â€¢ Dashboard: http://192.168.1.30:8123
          â€¢ Grafana: http://192.168.1.30:3000
          â€¢ Node-RED: http://192.168.1.30:1880
          
          Report generated by Home Assistant V3.2
          Next report: {{ (now() + timedelta(days=1)).strftime('%Y-%m-%d at 09:00') }}
          
    # Step 6: Send Telegram summary for mobile
    - service: notify.telegram
      data:
        title: "ğŸ  Daily Summary"
        message: |
          Good morning! Here's your smart home summary:
          
          âš¡ Energy: {{ states('sensor.average_battery_soc') }}% battery
          ğŸŒ Solar: {{ states('sensor.combined_solar_generation') }}W
          ğŸ¤– Automations: {{ states('sensor.active_automations_count') }} active
          ğŸ–¥ï¸ System: {{ states('sensor.system_uptime_days') }} days uptime
          
          {% if states('sensor.average_battery_soc') | float(100) < 25 %}
          âš ï¸ Battery low - {{ states('sensor.average_battery_soc') }}%
          {% elif states('sensor.combined_solar_generation') | float(0) > 5000 %}
          â˜€ï¸ Excellent solar conditions today!
          {% endif %}
          
          Full report sent via email.

    # Step 7: Reset daily counters
    - service: counter.reset
      entity_id: counter.daily_automations_triggered
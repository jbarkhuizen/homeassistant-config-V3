#===============================================================================
# Fixed Automations Configuration
# File: /config/automations.yaml
#===============================================================================

# Daily Telegram Test - Fixed
#- id: send_test_telegram_daily
#  alias: "Send Test Telegram Message Daily at 09:00"
#  description: "Daily Telegram functionality test"
#  trigger:
#    - platform: time
#      at: "09:00:00"
#  condition: []
#  action:
#    - service: notify.telegram
#      data:
#        title: "ðŸ  Daily Status Check"
#        message: |
#          Home Assistant Daily Report - {{ now().strftime('%Y-%m-%d') }}
#          
#          ðŸŸ¢ System Status: Online
#          â° Time: {{ now().strftime('%H:%M:%S') }}
#          ðŸŒ¡ï¸ System Temp: {{ states('sensor.johanba_server_system_temperature') | default('N/A') }}Â°C
#          ðŸ’¾ Memory Usage: {{ states('sensor.johanba_server_memory_usage') | default('N/A') }}%
#          
#          Telegram notifications are working correctly! âœ…

# Daily Email Test - New
- id: send_test_email_daily
  alias: "Send Test Email Daily at 09:00"
  description: "Daily Email functionality test"
  trigger:
    - platform: time
      at: "09:00:00"
  condition: []
  action:
    - delay: 30  # Stagger after Telegram
    - service: notify.email_ha
      data:
        title: "ðŸ  Daily Home Assistant Status - {{ now().strftime('%Y-%m-%d') }}"
        message: |
          Daily Home Assistant Status Report
          Generated: {{ now().strftime('%Y-%m-%d at %H:%M:%S') }}
          
          ðŸ  System: Home Assistant (192.168.1.30:8123)
          
          ðŸ“Š SYSTEM HEALTH:
          â€¢ Status: {{ 'Online âœ…' if states('sensor.johanba_server_status') == 'good' else 'Check Required âš ï¸' }}
          â€¢ System Temperature: {{ states('sensor.johanba_server_system_temperature') | default('N/A') }}Â°C
          â€¢ CPU Usage: {{ states('sensor.johanba_server_cpu_usage') | default('N/A') }}%
          â€¢ Memory Usage: {{ states('sensor.johanba_server_memory_usage') | default('N/A') }}%
          â€¢ Uptime: {{ states('sensor.johanba_server_uptime') | default('N/A') }}
          
          â˜ï¸ ONEDRIVE STATUS:
          â€¢ Storage Used: {{ states('sensor.onedrive_used_storage') | default('N/A') }}GB
          â€¢ Total Available: {{ states('sensor.onedrive_total_available_storage') | default('N/A') }}GB
          â€¢ Drive State: {{ states('sensor.onedrive_drive_state') | default('N/A') | title }}
          
          ðŸ”‹ ENERGY MONITORING:
          â€¢ OneDrive Usage: {{ states('sensor.onedrive_usage_percentage') | default('N/A') }}%
          
          ðŸŒ NETWORK STATUS:
          â€¢ WAN Status: {{ 'Connected âœ…' if is_state('binary_sensor.archer_d2_wan_status', 'on') else 'Check Connection âš ï¸' }}
          â€¢ External IP: {{ states('sensor.archer_d2_external_ip') | default('N/A') }}
          
          ðŸ“ˆ ADDONS STATUS:
          â€¢ File Editor: {{ 'Running âœ…' if is_state('binary_sensor.file_editor_running', 'on') else 'Stopped âŒ' }}
          â€¢ Code Server: {{ 'Running âœ…' if is_state('binary_sensor.studio_code_server_running', 'on') else 'Stopped âŒ' }}
          â€¢ Terminal SSH: {{ 'Running âœ…' if is_state('binary_sensor.terminal_ssh_running', 'on') else 'Stopped âŒ' }}
          
          This automated report confirms your email notifications are working correctly.
          
          Best regards,
          Home Assistant Automation System

# Weekly System Report - New
- id: weekly_system_report
  alias: "Weekly System Report - Sunday 09:00"
  description: "Comprehensive weekly system report"
  trigger:
    - platform: time
      at: "09:00:00"
  condition:
    - condition: time
      weekday:
        - sun
  action:
    - service: notify.email_ha
      data:
        title: "ðŸ“Š Weekly Home Assistant System Report - {{ now().strftime('%Y-%m-%d') }}"
        message: |
          Weekly Home Assistant System Report
          Week Ending: {{ now().strftime('%Y-%m-%d') }}
          
          ðŸ  SYSTEM OVERVIEW:
          â€¢ Instance: Home Assistant (192.168.1.30:8123)
          â€¢ OS Version: {{ states('sensor.home_assistant_operating_system_version') | default('N/A') }}
          â€¢ Core Version: Available in System Info
          
          ðŸ“Š PERFORMANCE METRICS:
          â€¢ Server Status: {{ states('sensor.johanba_server_status') | default('N/A') | title }}
          â€¢ Average CPU Usage: {{ states('sensor.johanba_server_cpu_usage') | default('N/A') }}%
          â€¢ Average Memory Usage: {{ states('sensor.johanba_server_memory_usage') | default('N/A') }}%
          â€¢ System Temperature: {{ states('sensor.johanba_server_system_temperature') | default('N/A') }}Â°C
          
          ðŸ’¾ STORAGE STATUS:
          â€¢ HA Disk Used: {{ states('sensor.home_assistant_host_disk_used') | default('N/A') }}GB
          â€¢ HA Disk Free: {{ states('sensor.home_assistant_host_disk_free') | default('N/A') }}GB
          â€¢ OneDrive Used: {{ states('sensor.onedrive_used_storage') | default('N/A') }}GB
          â€¢ OneDrive Free: {{ states('sensor.onedrive_remaining_storage') | default('N/A') }}GB
          
          ðŸ”Œ ADDON STATUS:
          â€¢ InfluxDB: Installed âœ…
          â€¢ Grafana: Installed âœ…
          â€¢ Node-RED: Installed âœ…
          â€¢ Mosquitto: Installed âœ…
          â€¢ Code Server: {{ 'Running âœ…' if is_state('binary_sensor.studio_code_server_running', 'on') else 'Check Status âš ï¸' }}
          
          ðŸŒ INTEGRATIONS:
          â€¢ GitHub: {{ 'Connected âœ…' if states('sensor.jbarkhuizen_automation_code_stars') != 'unavailable' else 'Check Connection âš ï¸' }}
          â€¢ OneDrive: {{ 'Connected âœ…' if states('sensor.onedrive_drive_state') != 'unavailable' else 'Check Connection âš ï¸' }}
          â€¢ Telegram: {{ 'Configured âœ…' if states('binary_sensor.telegram_bot_connected') == 'on' else 'Check Bot âš ï¸' }}
          
          ðŸ“± NOTIFICATIONS:
          â€¢ Email: âœ… Working (you're receiving this!)
          â€¢ Telegram: Check daily messages for status
          
          ðŸ”§ RECOMMENDATIONS:
          â€¢ Regular backups are configured
          â€¢ System monitoring is active
          â€¢ All critical services monitored
          
          Next weekly report: {{ (now() + timedelta(days=7)).strftime('%Y-%m-%d') }}
          
          Best regards,
          Home Assistant Weekly Report System
    - delay: 60
#    - service: notify.telegram
#      data:
#        message: |
#          ðŸ“Š Weekly Report Sent
#          
#          Comprehensive system report emailed at {{ now().strftime('%H:%M:%S') }}
#          
#          Check your email for detailed weekly statistics! ðŸ“§

# Test notification system - Manual trigger
#- id: test_notification_system_manual
#  alias: "Test Notification System - Manual"
#  description: "Manually test both email and Telegram"
#  trigger:
#    - platform: event
#      event_type: test_notifications
#  action:
#    - service: script.test_all_notifications
#
#===============================================================================
# Home Assistant Startup Email - Modern Syntax
# Add this to your automations.yaml file
#===============================================================================

- id: startup_email_notification
  alias: Home Assistant Startup Email
  description: Send comprehensive email when HA starts
  triggers:
    - trigger: homeassistant
      event: start
  actions:
    - delay:
        minutes: 2
    - action: notify.email_ha
      data:
        title: "ðŸ  Home Assistant Startup Complete - {{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        message: |
          Home Assistant Startup Notification
          ====================================
          
          ðŸ• RESTART DETAILS:
          â€¢ Startup Time: {{ now().strftime('%Y-%m-%d at %H:%M:%S') }}
          â€¢ Server: 192.168.1.30:8123
          â€¢ Previous Uptime: {{ relative_time(states.sensor.last_boot.last_changed) if states('sensor.last_boot') != 'unavailable' else 'Unknown' }}
          
          ðŸ–¥ï¸ SYSTEM STATUS:
          â€¢ Home Assistant Core: {{ states('sensor.home_assistant_core_cpu_percent') | default('N/A') }}% CPU
          â€¢ Supervisor: {{ states('sensor.home_assistant_supervisor_cpu_percent') | default('N/A') }}% CPU
          â€¢ System Temperature: {{ states('sensor.johanba_server_system_temperature') | default('N/A') }}Â°C
          â€¢ Memory Usage: {{ states('sensor.johanba_server_memory_usage') | default('N/A') }}%
          â€¢ Server Status: {{ states('sensor.johanba_server_status') | default('N/A') | title }}
          
          ðŸ“Š VERSION INFORMATION:
          â€¢ HA OS Version: {{ states('sensor.home_assistant_operating_system_version') | default('N/A') }}
          â€¢ Latest Available: {{ states('sensor.home_assistant_operating_system_newest_version') | default('N/A') }}
          â€¢ Update Available: {{ 'Yes âš ï¸' if states('sensor.home_assistant_operating_system_version') != states('sensor.home_assistant_operating_system_newest_version') else 'No âœ…' }}
          
          ðŸ”Œ ADDON STATUS:
          â€¢ File Editor: {{ 'Running âœ…' if is_state('binary_sensor.file_editor_running', 'on') else 'Stopped âŒ' }}
          â€¢ Code Server: {{ 'Running âœ…' if is_state('binary_sensor.studio_code_server_running', 'on') else 'Stopped âŒ' }}
          â€¢ Terminal SSH: {{ 'Running âœ…' if is_state('binary_sensor.terminal_ssh_running', 'on') else 'Stopped âŒ' }}
          
          ðŸ’¾ STORAGE STATUS:
          â€¢ HA Disk Used: {{ states('sensor.home_assistant_host_disk_used') | default('N/A') }}GB / {{ states('sensor.home_assistant_host_disk_total') | default('N/A') }}GB
          â€¢ HA Disk Free: {{ states('sensor.home_assistant_host_disk_free') | default('N/A') }}GB
          â€¢ OneDrive Usage: {{ states('sensor.onedrive_usage_percentage') | default('N/A') }}%
          â€¢ OneDrive State: {{ states('sensor.onedrive_drive_state') | default('N/A') | title }}
          
          ðŸŒ NETWORK STATUS:
          â€¢ WAN Connection: {{ 'Connected âœ…' if is_state('binary_sensor.archer_d2_wan_status', 'on') else 'Disconnected âŒ' }}
          â€¢ External IP: {{ states('sensor.archer_d2_external_ip_2') | default('N/A') }}
          
          ðŸ“ˆ BACKUP STATUS:
          â€¢ Last Backup: {{ states('sensor.backup_last_successful_automatic_backup') | default('N/A') }}
          â€¢ Next Backup: {{ states('sensor.backup_next_scheduled_automatic_backup') | default('N/A') }}
          â€¢ Backup Status: {{ states('sensor.backup_backup_manager_state') | default('N/A') | title }}
          
          ðŸ” POTENTIAL ISSUES DETECTED:
          {% set issues = [] %}
          {% if states('sensor.johanba_server_system_temperature')|float(0) > 60 %}
            {% set issues = issues + ['High system temperature: ' + states('sensor.johanba_server_system_temperature') + 'Â°C'] %}
          {% endif %}
          {% if states('sensor.johanba_server_memory_usage')|float(0) > 80 %}
            {% set issues = issues + ['High memory usage: ' + states('sensor.johanba_server_memory_usage') + '%'] %}
          {% endif %}
          {% if not is_state('binary_sensor.archer_d2_wan_status', 'on') %}
            {% set issues = issues + ['Network connection issue detected'] %}
          {% endif %}
          {% if states('sensor.home_assistant_operating_system_version') != states('sensor.home_assistant_operating_system_newest_version') %}
            {% set issues = issues + ['Home Assistant OS update available'] %}
          {% endif %}
          {% if states('sensor.onedrive_usage_percentage')|float(0) > 85 %}
            {% set issues = issues + ['OneDrive storage usage high: ' + states('sensor.onedrive_usage_percentage') + '%'] %}
          {% endif %}
          {% if issues|length > 0 %}
            {% for issue in issues %}
          â€¢ {{ issue }}
            {% endfor %}
          {% else %}
          â€¢ No issues detected âœ…
          {% endif %}
          
          ðŸ“§ This automated message confirms Home Assistant has restarted successfully.
          All critical systems are being monitored.
          
          Dashboard: http://192.168.1.30:8123
          
          Best regards,
          Home Assistant Startup Monitor
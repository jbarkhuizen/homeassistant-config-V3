#===============================================================================
# Single comprehensive daily report at 09:00
#===============================================================================

# The below has been replaced with a Ver 2.0 
- id: comprehensive_daily_report_optimized_v1
  alias: "Daily System Report - Comprehensive (09:00) - Version 1.0"
  description: "Single optimized daily report covering all system aspects"
  trigger:
    - platform: time
      at: "09:00:00"
  condition: []
  action:
    # Step 1: Update all system metrics first
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.active_automations_count
          - sensor.disabled_automations_count
          - sensor.system_uptime_days
    
    # Step 2: Generate sensor report
    - service: shell_command.extract_sensors
      data: {}
    
    # Step 3: Wait for report generation to complete
    - delay:
        seconds: 60
    
    # Step 4: Send single comprehensive email
    - service: notify.email_ha
      data:
        title: "ğŸ  Daily Smart Home Report - {{ now().strftime('%A, %B %d, %Y') }}"
        message: |
          SMART HOME DAILY REPORT
          Generated: {{ now().strftime('%Y-%m-%d at %H:%M:%S') }}
          Location: Pierre van Ryneveld, Gauteng (192.168.1.30:8123)
          
          âš¡ ENERGY SYSTEM STATUS:
          â€¢ Master Battery SOC: {{ states('sensor.deyeinvertermaster_summary_battery_soc') | default('N/A') }}%
          â€¢ Slave Battery SOC: {{ states('sensor.deyeinverterslave_summary_battery_soc') | default('N/A') }}%
          â€¢ Daily Solar Generation: {{ states('sensor.deyeinvertermaster_summary_day_pv_generation') | default('N/A') }} kWh
          â€¢ Grid Status: {{ 'Online' if states('sensor.deyeinvertermaster_summary_battery_soc') not in ['unknown', 'unavailable'] else 'Check Required' }}
          
          ğŸ¤– AUTOMATION SYSTEM:
          â€¢ Active Automations: {{ states('sensor.active_automations_count') | default('N/A') }}
          â€¢ Disabled Automations: {{ states('sensor.disabled_automations_count') | default('N/A') }}
          â€¢ System Uptime: {{ states('sensor.system_uptime_days') | default('N/A') }} days
          â€¢ System Health: {{ 'Optimal' if states('sensor.active_automations_count') | int(0) > 0 else 'Check Required' }}
          
          ğŸ’¾ SYSTEM PERFORMANCE:
          â€¢ CPU Usage: {{ states('sensor.processor_use') | default('N/A') }}%
          â€¢ Memory Usage: {{ states('sensor.memory_use_percent') | default('N/A') }}%
          â€¢ Database Size: {{ states('sensor.database_size') | default('N/A') }}MB
          
          ğŸ”— INTEGRATION STATUS:
          â€¢ SONOFF Devices: Connected
          â€¢ TUYA Devices: Connected
          â€¢ OneDrive: {{ states('sensor.onedrive_drive_state') | default('N/A') | title }}
          â€¢ InfluxDB: Recording
          â€¢ Telegram: âœ… Active
          â€¢ Email Services: âœ… Operational
          
          ğŸ“Š SENSOR REPORTS:
          â€¢ Report Files: âœ… Generated (/config/sensor_reports/)
          â€¢ CSV Export: sensors_report_{{ now().strftime('%Y%m%d_090000') }}.csv
          â€¢ JSON Export: sensors_report_{{ now().strftime('%Y%m%d_090000') }}.json
          â€¢ Summary: sensors_summary_{{ now().strftime('%Y%m%d_090000') }}.md
          
          âš™ï¸ RECOMMENDED ACTIONS:
          {% if states('sensor.deyeinvertermaster_summary_battery_soc') | float(100) < 30 %}
          â€¢ âš ï¸ Monitor battery levels - Master at {{ states('sensor.deyeinvertermaster_summary_battery_soc') }}%
          {% endif %}
          {% if states('sensor.processor_use') | float(0) > 70 %}
          â€¢ ğŸ–¥ï¸ Check system performance - CPU usage at {{ states('sensor.processor_use') }}%
          {% endif %}
          {% if states('sensor.system_uptime_days') | int(0) > 30 %}
          â€¢ ğŸ”„ Consider planned system restart - uptime {{ states('sensor.system_uptime_days') }} days
          {% endif %}
          
          ğŸ”— Quick Access:
          â€¢ Dashboard: http://192.168.1.30:8123
          â€¢ File Editor: /config/sensor_reports/
          
          Next report: {{ (now() + timedelta(days=1)).strftime('%Y-%m-%d at 09:00') }}
          
          Best regards,
          Home Assistant Automation System
    
    # Step 5: Send Telegram confirmation (CORRECTED SERVICE)
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_id
        title: "ğŸ“Š Daily Report Sent"
        message: |
          Daily system report completed at {{ now().strftime('%H:%M:%S') }}
          
          ğŸ“§ Email sent successfully
          ğŸ“ Reports saved to /config/sensor_reports/
          âœ… All systems operational
#===============================================================================
# Single comprehensive daily report at 09:00 with all metrics
#===============================================================================

- id: comprehensive_daily_report_consolidated_v2
  alias: "Daily System Report - Consolidated (09:00) - Version 2.0"
  description: "Single optimized daily report covering all system aspects with error detection"
  trigger:
    - platform: time
      at: "09:00:00"
  
  condition: []
  
  action:
    # Step 1: Update all system metrics first
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.active_automations_count
          - sensor.disabled_automations_count
          - sensor.system_uptime_days
      continue_on_error: true
    
    # Step 2: Generate sensor report
    - service: shell_command.extract_sensors
      data: {}
      continue_on_error: true
    
    # Step 3: Wait for report generation to complete
    - delay:
        seconds: 60
    
    # Step 4: Send comprehensive Telegram summary (short & sweet)
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_id
        title: "ğŸ  Good Morning - Daily System Check"
        message: |
          **{{ now().strftime('%A, %B %d, %Y') }} - 09:00**
          
          âš¡ **ENERGY STATUS:**
          â€¢ Master Battery: {{ states('sensor.deyeinvertermaster_summary_battery_soc') | default('N/A') }}%
          â€¢ Slave Battery: {{ states('sensor.deyeinverterslave_summary_battery_soc') | default('N/A') }}%
          â€¢ Avg Battery: {{ ((states('sensor.deyeinvertermaster_summary_battery_soc') | float(0) + states('sensor.deyeinverterslave_summary_battery_soc') | float(0)) / 2) | round(1) }}%
          â€¢ Solar Power: {{ states('sensor.deyeinvertermaster_pv_power') | default('0') }}W
          â€¢ Load Power: {{ states('sensor.deyeinvertermaster_load_power') | default('0') }}W
          â€¢ Inverter Mode: {{ states('select.deyeinvertermaster_load_limit_exp_ess_non_ess') | default('N/A') }}
          
          ğŸ¤– **SYSTEM HEALTH:**
          â€¢ Active Automations: {{ states('sensor.active_automations_count') | default('N/A') }}
          â€¢ System Uptime: {{ states('sensor.system_uptime_days') | default('N/A') }} days
          â€¢ CPU Usage: {{ states('sensor.processor_use') | default('N/A') }}%
          â€¢ Memory Usage: {{ states('sensor.memory_use_percent') | default('N/A') }}%
          
          {% set master_battery = states('sensor.deyeinvertermaster_summary_battery_soc') | float(100) %}
          {% set slave_battery = states('sensor.deyeinverterslave_summary_battery_soc') | float(100) %}
          {% set avg_battery = (master_battery + slave_battery) / 2 %}
          {% set cpu = states('sensor.processor_use') | float(0) %}
          {% set master_online = states('sensor.deyeinvertermaster_summary_battery_soc') not in ['unknown', 'unavailable'] %}
          {% set slave_online = states('sensor.deyeinverterslave_summary_battery_soc') not in ['unknown', 'unavailable'] %}
          âš ï¸ **ALERTS:**
          {% if not master_online %}
          â€¢ ğŸ”´ Master Inverter: OFFLINE
          {% elif not slave_online %}
          â€¢ ğŸ”´ Slave Inverter: OFFLINE
          {% elif avg_battery < 20 %}
          â€¢ ğŸŸ¡ Low Battery Warning: {{ avg_battery | round(1) }}%
          {% elif cpu > 80 %}
          â€¢ ğŸŸ¡ High CPU Usage: {{ cpu }}%
          {% else %}
          â€¢ âœ… All Systems Normal
          {% endif %}
          
          ğŸ“§ Detailed report emailed to jbarkhuizen@gmail.com
          ğŸ“Š Sensor data: /config/sensor_reports/
          
          Next check: {{ (now() + timedelta(days=1)).strftime('%Y-%m-%d at 09:00') }}
    
    # Step 5: Send comprehensive email report (detailed)
    - service: notify.email_ha
      data:
        title: "ğŸ  Daily Smart Home Report - {{ now().strftime('%A, %B %d, %Y') }}"
        message: |
          COMPREHENSIVE DAILY SYSTEM REPORT
          Generated: {{ now().strftime('%Y-%m-%d at %H:%M:%S') }}
          Location: Pierre van Ryneveld, Gauteng (192.168.1.30:8123)
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âš¡ INVERTER & ENERGY SYSTEM STATUS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ”‹ BATTERY STATUS:
          â€¢ Master Inverter SOC: {{ states('sensor.deyeinvertermaster_summary_battery_soc') | default('N/A') }}%
          â€¢ Slave Inverter SOC: {{ states('sensor.deyeinverterslave_summary_battery_soc') | default('N/A') }}%
          â€¢ Average Battery Level: {{ ((states('sensor.deyeinvertermaster_summary_battery_soc') | float(0) + states('sensor.deyeinverterslave_summary_battery_soc') | float(0)) / 2) | round(1) }}%
          â€¢ Battery Status: {% set avg = ((states('sensor.deyeinvertermaster_summary_battery_soc') | float(0) + states('sensor.deyeinverterslave_summary_battery_soc') | float(0)) / 2) %}{{ 'Excellent âœ…' if avg >= 80 else 'Good âœ…' if avg >= 50 else 'Low âš ï¸' if avg >= 20 else 'Critical ğŸ”´' }}
          
          â˜€ï¸ SOLAR GENERATION (Yesterday):
          â€¢ Master PV Generation: {{ states('sensor.deyeinvertermaster_summary_day_pv_generation') | default('N/A') }} kWh
          â€¢ Slave PV Generation: {{ states('sensor.deyeinverterslave_summary_day_pv_generation') | default('N/A') }} kWh
          â€¢ Total Daily Solar: {{ (states('sensor.deyeinvertermaster_summary_day_pv_generation') | float(0) + states('sensor.deyeinverterslave_summary_day_pv_generation') | float(0)) | round(2) }} kWh
          â€¢ Current Solar Power: {{ states('sensor.deyeinvertermaster_pv_power') | default('0') }}W
          
          âš¡ POWER CONSUMPTION:
          â€¢ Current Load Power: {{ states('sensor.deyeinvertermaster_load_power') | default('N/A') }}W
          â€¢ Daily Load Consumption: {{ states('sensor.deyeinvertermaster_summary_day_load_consumption') | default('N/A') }} kWh
          â€¢ Grid Import (Yesterday): {{ states('sensor.deyeinvertermaster_today_energy_bought') | default('N/A') }} kWh
          â€¢ Grid Export (Yesterday): {{ states('sensor.deyeinvertermaster_today_energy_sold') | default('N/A') }} kWh
          
          ğŸ”§ INVERTER CONFIGURATION:
          â€¢ Current Mode: {{ states('select.deyeinvertermaster_load_limit_exp_ess_non_ess') | default('N/A') }}
          â€¢ Energy Management: {{ states('input_select.energy_mode') | default('Automatic') }}
          â€¢ Master Inverter Status: {{ 'Online âœ…' if states('sensor.deyeinvertermaster_summary_battery_soc') not in ['unknown', 'unavailable'] else 'Check Connection âš ï¸' }}
          â€¢ Slave Inverter Status: {{ 'Online âœ…' if states('sensor.deyeinverterslave_summary_battery_soc') not in ['unknown', 'unavailable'] else 'Check Connection âš ï¸' }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ¤– HOME ASSISTANT SYSTEM STATUS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š AUTOMATION SYSTEM:
          â€¢ Active Automations: {{ states('sensor.active_automations_count') | default('N/A') }}
          â€¢ Disabled Automations: {{ states('sensor.disabled_automations_count') | default('N/A') }}
          â€¢ Automations Triggered Today: {{ states('counter.daily_automations_triggered') | default('0') }}
          â€¢ Last Automation: {{ states('sensor.last_automation_triggered') | default('N/A') }}
          â€¢ Maintenance Mode: {{ 'Active ğŸ”§' if is_state('input_boolean.maintenance_mode', 'on') else 'Inactive âœ…' }}
          
          ğŸ’» SYSTEM PERFORMANCE:
          â€¢ System Uptime: {{ states('sensor.system_uptime_days') | default('N/A') }} days
          â€¢ CPU Usage: {{ states('sensor.processor_use') | default('N/A') }}%
          â€¢ Memory Usage: {{ states('sensor.memory_use_percent') | default('N/A') }}%
          â€¢ Disk Usage: {{ states('sensor.disk_use_percent_config') | default('N/A') }}%
          â€¢ Database Size: {{ states('sensor.database_size') | default('N/A') }} MB
          â€¢ System Load (15min): {{ states('sensor.load_15m') | default('N/A') }}
          
          ğŸ”— INTEGRATION STATUS:
          â€¢ SONOFF Devices: Connected âœ…
          â€¢ TUYA Devices: Connected âœ…
          â€¢ OneDrive Backup: {{ states('sensor.onedrive_drive_state') | default('N/A') | title }}
          â€¢ OneDrive Storage: {{ states('sensor.onedrive_used_storage') | default('N/A') }}GB / {{ states('sensor.onedrive_total_available_storage') | default('N/A') }}GB
          â€¢ InfluxDB: Recording âœ…
          â€¢ Telegram Bot: Active âœ…
          â€¢ Email Services: Operational âœ…
          â€¢ GitHub Sync: {{ 'Up to date âœ…' if has_value('sensor.jbarkhuizen_homeassistant_config_v3_latest_commit') else 'Check Required âš ï¸' }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“Š SENSOR EXTRACTION REPORT
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Daily sensor extraction completed successfully!
          
          ğŸ“ Generated Files:
          â€¢ CSV Export: sensors_report_{{ now().strftime('%Y%m%d_090000') }}.csv
          â€¢ JSON Export: sensors_report_{{ now().strftime('%Y%m%d_090000') }}.json
          â€¢ Summary Report: sensors_summary_{{ now().strftime('%Y%m%d_090000') }}.md
          â€¢ File Location: /config/sensor_reports/
          
          ğŸ“ˆ Access via File Editor or SSH for detailed sensor data
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âš™ï¸ RECOMMENDED ACTIONS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% set master_battery = states('sensor.deyeinvertermaster_summary_battery_soc') | float(100) %}
          {% set slave_battery = states('sensor.deyeinverterslave_summary_battery_soc') | float(100) %}
          {% set avg_battery = (master_battery + slave_battery) / 2 %}
          {% set cpu = states('sensor.processor_use') | float(0) %}
          {% set uptime = states('sensor.system_uptime_days') | int(0) %}
          {% set disabled = states('sensor.disabled_automations_count') | int(0) %}
          {% set master_online = states('sensor.deyeinvertermaster_summary_battery_soc') not in ['unknown', 'unavailable'] %}
          {% set slave_online = states('sensor.deyeinverterslave_summary_battery_soc') not in ['unknown', 'unavailable'] %}
          
          {% if not master_online %}
          ğŸ”´ CRITICAL: Master inverter offline - Check connection immediately!
          {% elif not slave_online %}
          ğŸ”´ CRITICAL: Slave inverter offline - Check connection immediately!
          {% elif avg_battery < 20 %}
          âš ï¸ WARNING: Battery levels low ({{ avg_battery | round(1) }}%) - Monitor closely, reduce non-essential loads
          {% elif cpu > 80 %}
          âš ï¸ WARNING: High CPU usage ({{ cpu }}%) - Check system performance, consider restart
          {% elif uptime > 30 %}
          ğŸ’¡ SUGGESTION: System uptime is {{ uptime }} days - Consider planned restart for optimal performance
          {% elif disabled > 0 %}
          ğŸ’¡ INFO: {{ disabled }} automation(s) disabled - Review if intentional
          {% else %}
          âœ… All systems operating normally - No action required
          {% endif %}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ”— QUICK ACCESS LINKS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          â€¢ Home Assistant: http://192.168.1.30:8123
          â€¢ Grafana Dashboard: http://192.168.1.30:3000
          â€¢ Node-RED: http://192.168.1.30:1880
          â€¢ File Editor: http://192.168.1.30:8123 (Sidebar)
          â€¢ Sensor Reports: /config/sensor_reports/
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Report generated by Home Assistant Automation System
          Next comprehensive report: {{ (now() + timedelta(days=1)).strftime('%Y-%m-%d at 09:00') }}
          Weekly summary: Every Sunday at 09:00
          
          Best regards,
          Smart Home Automation System
          Pierre van Ryneveld Setup V3.2

    # Step 6: Reset daily counter
    - service: counter.reset
      target:
        entity_id: counter.daily_automations_triggered
      continue_on_error: true

  mode: single

#===============================================================================
# Sensor Report Auto-Cleanup - Every 14 Days
#===============================================================================

- id: sensor_reports_auto_cleanup
  alias: "Sensor Reports - Auto Cleanup (14 Days)"
  description: "Automatically delete sensor reports older than 14 days"
  trigger:
    - platform: time
      at: "09:30:00"
  
  condition:
    - condition: time
      weekday:
        - sun  # Run weekly on Sundays
  
  action:
    - service: shell_command.cleanup_sensor_reports
      data: {}
      continue_on_error: true
    
    - delay:
        seconds: 5
    
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_id
        message: |
          ğŸ§¹ **Sensor Reports Cleanup**
          
          Old sensor reports (>14 days) have been removed.
          
          Current reports folder: /config/sensor_reports/
          Cleanup runs every Sunday at 09:30
  
  mode: single

#===============================================================================
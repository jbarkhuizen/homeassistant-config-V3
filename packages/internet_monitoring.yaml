# Metrofibre Internet Monitoring Package - FIXED VERSION
# File: packages/internet_monitoring.yaml

# Input numbers for configuration
input_number:
  minimum_download_speed:
    name: "Minimum Download Speed"
    min: 100
    max: 500
    step: 10
    initial: 400
    unit_of_measurement: "Mbps"
    icon: mdi:download
  
  minimum_upload_speed:
    name: "Minimum Upload Speed"
    min: 100
    max: 500
    step: 10
    initial: 400
    unit_of_measurement: "Mbps"
    icon: mdi:upload
  
  maximum_ping_threshold:
    name: "Maximum Ping Threshold"
    min: 5
    max: 100
    step: 5
    initial: 20
    unit_of_measurement: "ms"
    icon: mdi:speedometer
  
  speed_test_interval:
    name: "Speed Test Interval"
    min: 5
    max: 120
    step: 5
    initial: 30
    unit_of_measurement: "minutes"
    icon: mdi:timer
  
  connection_timeout:
    name: "Connection Timeout"
    min: 30
    max: 120
    step: 10
    initial: 60
    unit_of_measurement: "seconds"
    icon: mdi:timer-off

# Input booleans for control
input_boolean:
  internet_monitoring_enabled:
    name: "Internet Monitoring Enabled"
    initial: true
    icon: mdi:monitor

  low_speed_alerts:
    name: "Low Speed Alerts"
    initial: true
    icon: mdi:alert-circle

  disconnection_alerts:
    name: "Disconnection Alerts"
    initial: true
    icon: mdi:wifi-off

  peak_hours_monitoring:
    name: "Peak Hours Enhanced Monitoring"
    initial: true
    icon: mdi:clock-alert

  complaint_mode:
    name: "Complaint Mode (Evidence Collection)"
    initial: false
    icon: mdi:file-document-alert

# Input selects for configuration
input_select:
  peak_hours_definition:
    name: "Peak Hours Definition"
    options:
      - "18:00-23:00 (Evening Peak)"
      - "19:00-22:00 (Prime Time)"
      - "17:00-21:00 (After Work)"
      - "20:00-23:00 (Night Peak)"
      - "Custom"
    initial: "19:00-22:00 (Prime Time)"
    icon: mdi:clock-time-eight

  monitoring_mode:
    name: "Monitoring Mode"
    options:
      - "Normal (30 min intervals)"
      - "Enhanced (15 min intervals)"
      - "Intensive (10 min intervals)"
      - "Troubleshooting (5 min intervals)"
      - "Documentation (3 min intervals)"
    initial: "Normal (30 min intervals)"
    icon: mdi:cog

# Cloudflare Speed Test Integration
speedtestdotnet:
  scan_interval:
    minutes: 30
  monitored_conditions:
    - ping
    - download
    - upload

# Command line sensors for Nokia router and network monitoring
sensor:
  # Nokia router connectivity check - FIXED
  - platform: command_line
    name: "Nokia Router Ping"
    command: "ping -c 1 -W 3 192.168.1.1"
    command_timeout: 10
    scan_interval: 60
    value_template: >
      {% if 'time=' in value %}
        {{ value.split('time=')[1].split('ms')[0] | float(999) | round(1) }}
      {% else %}
        999
      {% endif %}
    unit_of_measurement: "ms"

  # Google DNS connectivity - FIXED
  - platform: command_line
    name: "Google DNS Ping"
    command: "ping -c 1 -W 5 8.8.8.8"
    command_timeout: 10
    scan_interval: 120
    value_template: >
      {% if 'time=' in value %}
        {{ value.split('time=')[1].split('ms')[0] | float(999) | round(1) }}
      {% else %}
        999
      {% endif %}
    unit_of_measurement: "ms"

  # Cloudflare DNS connectivity - FIXED
  - platform: command_line
    name: "Cloudflare DNS Ping"
    command: "ping -c 1 -W 5 1.1.1.1"
    command_timeout: 10
    scan_interval: 120
    value_template: >
      {% if 'time=' in value %}
        {{ value.split('time=')[1].split('ms')[0] | float(999) | round(1) }}
      {% else %}
        999
      {% endif %}
    unit_of_measurement: "ms"

  # MTN DNS connectivity - FIXED
  - platform: command_line
    name: "MTN DNS Ping"
    command: "ping -c 1 -W 5 196.11.240.241"
    command_timeout: 10
    scan_interval: 300
    value_template: >
      {% if 'time=' in value %}
        {{ value.split('time=')[1].split('ms')[0] | float(999) | round(1) }}
      {% else %}
        999
      {% endif %}
    unit_of_measurement: "ms"

  # SAIX connectivity - FIXED
  - platform: command_line
    name: "SAIX Ping"
    command: "ping -c 1 -W 5 196.21.0.35"
    command_timeout: 10
    scan_interval: 300
    value_template: >
      {% if 'time=' in value %}
        {{ value.split('time=')[1].split('ms')[0] | float(999) | round(1) }}
      {% else %}
        999
      {% endif %}
    unit_of_measurement: "ms"

  # Packet loss check - FIXED
  - platform: command_line
    name: "Connection Packet Loss"
    command: "ping -c 10 -W 3 8.8.8.8"
    command_timeout: 30
    scan_interval: 900
    value_template: >
      {% if '% packet loss' in value %}
        {{ value.split('% packet loss')[0].split()[-1] | float(0) }}
      {% else %}
        0
      {% endif %}
    unit_of_measurement: "%"

  # Route stability check - FIXED
  - platform: command_line
    name: "Internet Route Hops"
    command: "traceroute -m 20 8.8.8.8 2>/dev/null | wc -l"
    command_timeout: 60
    scan_interval: 1800
    value_template: >
      {% set hops = value | int(0) %}
      {% if hops > 1 %}
        {{ hops - 1 }}
      {% else %}
        0
      {% endif %}

# Template sensors for advanced analysis
template:
  - sensor:
      # Download speed performance percentage
      - name: "Download Speed Performance"
        unique_id: download_speed_performance
        unit_of_measurement: "%"
        state: >
          {% set current = states('sensor.speedtest_download') | float(0) %}
          {% set contracted = 500 %}
          {% if current > 0 %}
            {{ ((current / contracted) * 100) | round(1) }}
          {% else %}
            0
          {% endif %}
        icon: mdi:percent

      # Upload speed performance percentage
      - name: "Upload Speed Performance"
        unique_id: upload_speed_performance
        unit_of_measurement: "%"
        state: >
          {% set current = states('sensor.speedtest_upload') | float(0) %}
          {% set contracted = 500 %}
          {% if current > 0 %}
            {{ ((current / contracted) * 100) | round(1) }}
          {% else %}
            0
          {% endif %}
        icon: mdi:percent

      # Fiber network quality score
      - name: "Fiber Network Quality Score"
        unique_id: fiber_network_quality_score
        unit_of_measurement: "%"
        state: >
          {% set download_perf = states('sensor.download_speed_performance') | float(0) %}
          {% set upload_perf = states('sensor.upload_speed_performance') | float(0) %}
          {% set ping = states('sensor.speedtest_ping') | float(999) %}
          {% set packet_loss = states('sensor.connection_packet_loss') | float(0) %}
          
          {% set ping_score = max(0, 100 - (ping * 3)) %}
          {% set packet_loss_score = max(0, 100 - (packet_loss * 20)) %}
          {% set speed_score = (download_perf + upload_perf) / 2 %}
          
          {% set final_score = (speed_score * 0.6) + (ping_score * 0.3) + (packet_loss_score * 0.1) %}
          {{ final_score | round(1) }}
        icon: mdi:speedometer

      # Connection status summary
      - name: "Metrofibre Connection Status"
        unique_id: metrofibre_connection_status
        state: >
          {% set router_ping = states('sensor.nokia_router_ping') | float(999) %}
          {% set internet_ping = states('sensor.google_dns_ping') | float(999) %}
          {% set download = states('sensor.speedtest_download') | float(0) %}
          {% set upload = states('sensor.speedtest_upload') | float(0) %}
          
          {% if router_ping >= 999 %}
            Router Issue
          {% elif internet_ping >= 999 %}
            Internet Disconnected
          {% elif download < 200 or upload < 200 %}
            Speed Issues
          {% elif download < 400 or upload < 400 %}
            Performance Degraded
          {% else %}
            Optimal
          {% endif %}
        icon: mdi:connection

      # Connection uptime status
      - name: "Connection Uptime Status"
        unique_id: connection_uptime_status
        state: >
          {% set router_online = states('sensor.nokia_router_ping') | float(999) < 50 %}
          {% set internet_online = states('sensor.google_dns_ping') | float(999) < 200 %}
          
          {% if not router_online %}
            Router Offline
          {% elif not internet_online %}
            Internet Disconnected
          {% else %}
            Connected
          {% endif %}
        icon: mdi:wifi-check

      # Peak hours status
      - name: "Peak Hours Status"
        unique_id: peak_hours_status
        state: >
          {% set current_time = now().strftime('%H:%M') %}
          {% set peak_def = states('input_select.peak_hours_definition') %}
          
          {% if peak_def == '19:00-22:00 (Prime Time)' %}
            {% if '19:00' <= current_time <= '22:00' %}
              Active
            {% else %}
              Inactive
            {% endif %}
          {% elif peak_def == '18:00-23:00 (Evening Peak)' %}
            {% if '18:00' <= current_time <= '23:00' %}
              Active
            {% else %}
              Inactive
            {% endif %}
          {% elif peak_def == '17:00-21:00 (After Work)' %}
            {% if '17:00' <= current_time <= '21:00' %}
              Active
            {% else %}
              Inactive
            {% endif %}
          {% elif peak_def == '20:00-23:00 (Night Peak)' %}
            {% if '20:00' <= current_time <= '23:00' %}
              Active
            {% else %}
              Inactive
            {% endif %}
          {% else %}
            Inactive
          {% endif %}
        icon: mdi:clock-alert

      # Current test interval based on mode and peak hours
      - name: "Current Test Interval"
        unique_id: current_test_interval
        unit_of_measurement: "minutes"
        state: >
          {% set mode = states('input_select.monitoring_mode') %}
          {% set peak_active = is_state('sensor.peak_hours_status', 'Active') %}
          {% set enhanced_monitoring = is_state('input_boolean.peak_hours_monitoring', 'on') %}
          
          {% if mode == 'Troubleshooting (5 min intervals)' %}
            5
          {% elif mode == 'Documentation (3 min intervals)' %}
            3
          {% elif mode == 'Intensive (10 min intervals)' %}
            10
          {% elif mode == 'Enhanced (15 min intervals)' %}
            15
          {% elif peak_active and enhanced_monitoring %}
            15
          {% else %}
            {{ states('input_number.speed_test_interval') | int(30) }}
          {% endif %}

      # Performance summary for reports
      - name: "Metrofibre Performance Summary"
        unique_id: metrofibre_performance_summary
        state: >
          üìä PERFORMANCE SNAPSHOT:
          ‚Ä¢ Download: {{ states('sensor.speedtest_download') }}Mbps ({{ states('sensor.download_speed_performance') }}%)
          ‚Ä¢ Upload: {{ states('sensor.speedtest_upload') }}Mbps ({{ states('sensor.upload_speed_performance') }}%)
          ‚Ä¢ Latency: {{ states('sensor.speedtest_ping') }}ms
          ‚Ä¢ Quality: {{ states('sensor.fiber_network_quality_score') }}%
          ‚Ä¢ Status: {{ states('sensor.metrofibre_connection_status') }}

  - binary_sensor:
      # Nokia router connectivity
      - name: "Nokia Router Online"
        unique_id: nokia_router_online
        device_class: connectivity
        state: >
          {{ states('sensor.nokia_router_ping') | float(999) < 50 }}

      # Internet connectivity
      - name: "Internet Connected"
        unique_id: internet_connected
        device_class: connectivity
        state: >
          {% set google = states('sensor.google_dns_ping') | float(999) %}
          {% set cloudflare = states('sensor.cloudflare_dns_ping') | float(999) %}
          {{ google < 200 or cloudflare < 200 }}

      # Speed critically low
      - name: "Speed Critically Low"
        unique_id: speed_critically_low
        device_class: problem
        state: >
          {% set download = states('sensor.speedtest_download') | float(0) %}
          {% set upload = states('sensor.speedtest_upload') | float(0) %}
          {% set min_down = states('input_number.minimum_download_speed') | float(400) %}
          {% set min_up = states('input_number.minimum_upload_speed') | float(400) %}
          {{ download < min_down or upload < min_up }}

      # Fiber latency high
      - name: "Fiber Latency High"
        unique_id: fiber_latency_high
        device_class: problem
        state: >
          {% set ping = states('sensor.speedtest_ping') | float(0) %}
          {% set threshold = states('input_number.maximum_ping_threshold') | float(20) %}
          {{ ping > threshold }}

      # Connection quality poor
      - name: "Fiber Quality Poor"
        unique_id: fiber_quality_poor
        device_class: problem
        state: >
          {{ states('sensor.fiber_network_quality_score') | float(100) < 70 }}

      # Packet loss detected
      - name: "Packet Loss Detected"
        unique_id: packet_loss_detected
        device_class: problem
        state: >
          {{ states('sensor.connection_packet_loss') | float(0) > 0.5 }}

      # Metrofibre issue detected
      - name: "Metrofibre Issue Detected"
        unique_id: metrofibre_issue_detected
        device_class: problem
        state: >
          {% set router_ok = is_state('binary_sensor.nokia_router_online', 'on') %}
          {% set internet_issue = is_state('binary_sensor.internet_connected', 'off') %}
          {% set speed_issue = is_state('binary_sensor.speed_critically_low', 'on') %}
          {% set quality_issue = is_state('binary_sensor.fiber_quality_poor', 'on') %}
          {% set packet_loss = is_state('binary_sensor.packet_loss_detected', 'on') %}
          {{ router_ok and (internet_issue or speed_issue or quality_issue or packet_loss) }}

      # Connection disconnected
      - name: "Connection Disconnected"
        unique_id: connection_disconnected
        device_class: problem
        state: >
          {% set uptime_status = states('sensor.connection_uptime_status') %}
          {{ uptime_status in ['Router Offline', 'Internet Disconnected'] }}

# Automations for monitoring
automation:
  # Dynamic speed testing
  - id: dynamic_speed_test_metrofibre
    alias: "Dynamic Speed Test - Metrofibre"
    description: "Run speed tests based on monitoring mode and peak hours"
    trigger:
      - platform: time_pattern
        minutes: "/5"
    condition:
      - condition: state
        entity_id: input_boolean.internet_monitoring_enabled
        state: 'on'
      - condition: template
        value_template: >
          {% set last_test = as_timestamp(states.sensor.speedtest_download.last_updated) %}
          {% set now_ts = as_timestamp(now()) %}
          {% set interval_minutes = states('sensor.current_test_interval') | int(30) %}
          {% set interval_seconds = interval_minutes * 60 %}
          {{ (now_ts - last_test) >= interval_seconds }}
    action:
      - service: speedtestdotnet.speedtest

  # Daily report automation - FIXED TIME
  - id: daily_metrofibre_report
    alias: "Daily Metrofibre Performance Report"
    description: "Comprehensive daily report at 9 AM"
    trigger:
      - platform: time
        at: "09:00:00"
    condition:
      - condition: state
        entity_id: input_boolean.internet_monitoring_enabled
        state: 'on'
    action:
      - service: notify.persistent_notification
        data:
          title: "üìä Daily Metrofibre Performance Report - {{ now().strftime('%Y-%m-%d') }}"
          message: |
            DAILY METROFIBRE PERFORMANCE SUMMARY
            Report Date: {{ now().strftime('%Y-%m-%d') }}
            Service: 500/500 Mbps Fiber
            Provider: Metrofibre
            
            üìà PERFORMANCE OVERVIEW:
            ‚Ä¢ Fiber Quality Score: {{ states('sensor.fiber_network_quality_score') }}%
            ‚Ä¢ Connection Status: {{ states('sensor.metrofibre_connection_status') }}
            ‚Ä¢ Download Performance: {{ states('sensor.download_speed_performance') }}% of contracted
            ‚Ä¢ Upload Performance: {{ states('sensor.upload_speed_performance') }}% of contracted
            ‚Ä¢ Connection Uptime: {{ states('sensor.connection_uptime_status') }}
            
            üåê CURRENT SPEEDS:
            ‚Ä¢ Download: {{ states('sensor.speedtest_download') }}Mbps (Contract: 500Mbps)
            ‚Ä¢ Upload: {{ states('sensor.speedtest_upload') }}Mbps (Contract: 500Mbps)
            ‚Ä¢ Latency: {{ states('sensor.speedtest_ping') }}ms
            ‚Ä¢ Jitter: {{ 'N/A' }}ms
            ‚Ä¢ Packet Loss: {{ states('sensor.connection_packet_loss') }}%
            
            üîß NOKIA ROUTER STATUS (192.168.1.1):
            ‚Ä¢ Model: Beacon 2 (ALCL)
            ‚Ä¢ Connectivity: {{ 'Online' if is_state('binary_sensor.nokia_router_online', 'on') else 'Issues Detected' }}
            ‚Ä¢ Response Time: {{ states('sensor.nokia_router_ping') }}ms
            ‚Ä¢ Hardware: 3FE49294CEAA
            ‚Ä¢ Software: 3FE49334JJKJ24
            
            üåê NETWORK DIAGNOSTICS:
            ‚Ä¢ Google DNS (8.8.8.8): {{ states('sensor.google_dns_ping') }}ms
            ‚Ä¢ Cloudflare DNS (1.1.1.1): {{ states('sensor.cloudflare_dns_ping') }}ms
            ‚Ä¢ MTN DNS: {{ states('sensor.mtn_dns_ping') }}ms
            ‚Ä¢ SAIX: {{ states('sensor.saix_ping') }}ms
            ‚Ä¢ Internet Route Hops: {{ states('sensor.internet_route_hops') }}
            
            üìä MONITORING CONFIGURATION:
            ‚Ä¢ Test Interval: {{ states('sensor.current_test_interval') }} minutes
            ‚Ä¢ Monitoring Mode: {{ states('input_select.monitoring_mode') }}
            ‚Ä¢ Peak Hours: {{ states('input_select.peak_hours_definition').split('(')[1].split(')')[0] }}
            ‚Ä¢ Peak Hours Status: {{ states('sensor.peak_hours_status') }}
            
            ‚ö†Ô∏è ISSUES DETECTED TODAY:
            ‚Ä¢ Speed Critically Low: {{ 'YES' if is_state('binary_sensor.speed_critically_low', 'on') else 'No' }}
            ‚Ä¢ High Latency: {{ 'YES' if is_state('binary_sensor.fiber_latency_high', 'on') else 'No' }}
            ‚Ä¢ Poor Quality: {{ 'YES' if is_state('binary_sensor.fiber_quality_poor', 'on') else 'No' }}
            ‚Ä¢ Packet Loss: {{ 'YES' if is_state('binary_sensor.packet_loss_detected', 'on') else 'No' }}
            ‚Ä¢ Disconnections: {{ 'YES' if is_state('binary_sensor.connection_disconnected', 'on') else 'No' }}
            ‚Ä¢ Metrofibre Issues: {{ 'YES' if is_state('binary_sensor.metrofibre_issue_detected', 'on') else 'No' }}
            
            üéØ CONFIGURED THRESHOLDS:
            ‚Ä¢ Min Download Speed: {{ states('input_number.minimum_download_speed') }}Mbps
            ‚Ä¢ Min Upload Speed: {{ states('input_number.minimum_upload_speed') }}Mbps
            ‚Ä¢ Max Latency: {{ states('input_number.maximum_ping_threshold') }}ms
            ‚Ä¢ Connection Timeout: {{ states('input_number.connection_timeout') }}s
            
            üîß ALERT SETTINGS:
            ‚Ä¢ Low Speed Alerts: {{ 'Enabled' if is_state('input_boolean.low_speed_alerts', 'on') else 'Disabled' }}
            ‚Ä¢ Disconnection Alerts: {{ 'Enabled' if is_state('input_boolean.disconnection_alerts', 'on') else 'Disabled' }}
            ‚Ä¢ Peak Hours Monitoring: {{ 'Enabled' if is_state('input_boolean.peak_hours_monitoring', 'on') else 'Disabled' }}
            ‚Ä¢ Complaint Mode: {{ 'Active' if is_state('input_boolean.complaint_mode', 'on') else 'Inactive' }}
            
            üìç LOCATION & SYSTEM:
            ‚Ä¢ Location: Pierre van Ryneveld, Gauteng, South Africa
            ‚Ä¢ Home Assistant: 192.168.1.30:8123
            ‚Ä¢ Router IP: 192.168.1.1
            ‚Ä¢ Provider: Metrofibre (Fiber)
            
            üìÖ RECOMMENDATIONS:
            {% if is_state('binary_sensor.speed_critically_low', 'on') %}
            ‚Ä¢ Contact Metrofibre support - speeds consistently below thresholds
            {% endif %}
            {% if is_state('binary_sensor.fiber_latency_high', 'on') %}
            ‚Ä¢ Check for network congestion during peak hours
            {% endif %}
            {% if is_state('binary_sensor.packet_loss_detected', 'on') %}
            ‚Ä¢ Check cable connections and router placement
            {% endif %}
            {% if not is_state('binary_sensor.metrofibre_issue_detected', 'on') %}
            ‚Ä¢ Performance within acceptable parameters
            {% endif %}
            
            Generated: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
            Next Report: {{ (now() + timedelta(days=1)).strftime('%Y-%m-%d') }} at 09:00

  # Issue detection and alerts
  - id: metrofibre_issue_detection
    alias: "Metrofibre Issue Detection Alert"
    description: "Alert when Metrofibre issues are detected"
    trigger:
      - platform: state
        entity_id: binary_sensor.metrofibre_issue_detected
        to: 'on'
        for:
          minutes: 3
    action:
      - service: notify.persistent_notification
        data:
          title: "üåê Metrofibre Performance Issue"
          message: |
            Issue detected: {{ states('sensor.metrofibre_connection_status') }}
            
            Current Performance:
            ‚Ä¢ Download: {{ states('sensor.speedtest_download') }}Mbps
            ‚Ä¢ Upload: {{ states('sensor.speedtest_upload') }}Mbps
            ‚Ä¢ Quality Score: {{ states('sensor.fiber_network_quality_score') }}%

# Scripts for manual operations
script:
  # Manual speed test
  run_metrofibre_speed_test:
    alias: "Run Metrofibre Speed Test"
    sequence:
      - service: speedtestdotnet.speedtest
      - delay:
          seconds: 60
      - service: notify.persistent_notification
        data:
          title: "üìä Speed Test Complete"
          message: |
            Results: {{ states('sensor.metrofibre_performance_summary') }}

  # Network diagnostic
  run_network_diagnostic:
    alias: "Run Network Diagnostic"
    sequence:
      - service: homeassistant.update_entity
        target:
          entity_id:
            - sensor.nokia_router_ping
            - sensor.google_dns_ping
            - sensor.cloudflare_dns_ping
            - sensor.mtn_dns_ping
            - sensor.saix_ping
            - sensor.connection_packet_loss
            - sensor.internet_route_hops
      - delay:
          seconds: 30
      - service: speedtestdotnet.speedtest
      - delay:
          seconds: 60
      - service: notify.persistent_notification
        data:
          title: "üîç Network Diagnostic Complete"
          message: |
            Network Status: {{ states('sensor.metrofibre_connection_status') }}
            Router: {{ states('sensor.nokia_router_ping') }}ms
            Quality: {{ states('sensor.fiber_network_quality_score') }}%